#!/usr/bin/env bash
# Lade .env, falls vorhanden
if [ -f .env ]; then
  set -a
  . ./.env
  set +a
fi

: "${IP:?IP fehlt (setze IP in .env)}"
: "${PORT:=443}"   # Default 443, falls nicht gesetzt
OUT="report.csv"

echo "input_domain,checked_host_unicode,checked_host_punycode,mode,curl_exit,status,redirect_url" > "$OUT"

to_puny () {
  python3 -c 'import sys; print(sys.argv[1].encode("idna").decode("ascii"))' "$1"
}

run_curl () {
  # args: host_a mode curl_extra_args
  local host_a="$1"
  local mode="$2"
  shift 2

  local out rc code redir

  out=$(curl -sS --connect-timeout 3 --max-time 8 \
    --resolve "${host_a}:${PORT}:${IP}" \
    -o /dev/null -w "%{http_code} %{redirect_url}" \
    "$@" "https://${host_a}/" 2>/dev/null)
  rc=$?

  code="${out%% *}"
  redir="${out#* }"
  [[ "$redir" == "$out" ]] && redir=""

  [[ -z "$code" ]] && code="ERR"

  # redirect_url nur bei 30x
  case "$code" in
    301|302|303|307|308) : ;;
    *) redir="" ;;
  esac

  # CSV-safe redirect url
  echo "${mode},${rc},${code},\"${redir}\""
}

check_host () {
  local host_u="$1" host_a
  host_a="$(to_puny "$host_u")"

  # 1) Secure (ohne -k)
  local secure_res mode rc code redir
  secure_res=$(run_curl "$host_a" "secure")
  mode="${secure_res%%,*}"; rest="${secure_res#*,}"
  rc="${rest%%,*}"; rest="${rest#*,}"
  code="${rest%%,*}"; redir="${rest#*,}"

  # Immer secure Zeile ausgeben
  echo "${host_a},${mode},${rc},${code},${redir}"

  # 2) Wenn secure scheitert: zusätzlich insecure (-k)
  # Kriterien: curl exit != 0 oder status 000/ERR
  if [[ "$rc" != "0" || "$code" == "000" || "$code" == "ERR" ]]; then
    local insecure_res
    insecure_res=$(run_curl "$host_a" "insecure" -k)
    echo "${host_a},${insecure_res}"
  fi
}

while IFS= read -r domain; do
  domain="$(echo "$domain" | tr -d ' \t\r')"
  [[ -z "$domain" || "$domain" =~ ^# ]] && continue

  domain="${domain#https://}"
  domain="${domain#http://}"
  domain="${domain%%/*}"

  # Basis ohne www (für doppelte Prüfung)
  if [[ "$domain" == www.* ]]; then
    base="${domain#www.}"
  else
    base="$domain"
  fi

  # 1) ohne www
  while IFS= read -r line; do
    hosta="${line%%,*}"; rest="${line#*,}"
    mode="${rest%%,*}"; rest="${rest#*,}"
    rc="${rest%%,*}"; rest="${rest#*,}"
    code="${rest%%,*}"; redir="${rest#*,}"
    echo "${domain},${base},${hosta},${mode},${rc},${code},${redir}" | tee -a "$OUT"
  done < <(check_host "$base")

  # 2) mit www
  www="www.${base}"
  while IFS= read -r line; do
    hosta="${line%%,*}"; rest="${line#*,}"
    mode="${rest%%,*}"; rest="${rest#*,}"
    rc="${rest%%,*}"; rest="${rest#*,}"
    code="${rest%%,*}"; redir="${rest#*,}"
    echo "${domain},${www},${hosta},${mode},${rc},${code},${redir}" | tee -a "$OUT"
  done < <(check_host "$www")

done < domains.txt
